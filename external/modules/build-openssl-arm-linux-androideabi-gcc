#! /bin/bash

platform=android-15
prefix=$(dirname ${PWD})/sysroot

for arg in "$@"
do
case $arg in
    platform=*|--platform=*)
    	platform="${arg#*=}"
    	shift
    	;;
    	
    prefix=*|--prefix=*)
    	prefix="${arg#*=}"
    	shift
    	;;    
    *)
    	echo "Unknown option $arg specified" 1>& 2
    	exit 1;
    ;;
esac
done

echo "platform=${platform}"
echo "Library will installed into ${prefix}"
mkdir -p "${prefix}" || exit 1



ndk_build=$(which ndk-build)
if [[ "$ndk_build" == "" ]] ; then
 echo "Can not locate ndk-build in PATH. Is NDK installed correctly?";
 exit 1;
fi

ndkroot=$(dirname "$ndk_build")
if [[ "$ndkroot" == "" ]] ; then
 echo "Can not locate NDK root. Is NDK installed correctly?";
 exit 1;
fi

sysroot="${ndkroot}/platforms/${platform}/arch-arm"
if [[ ! -d "${sysroot}" ]]; then
	echo "ERROR: ${sysroot} not exists."
	exit 1; 
fi


cd openssl || exit 1

# This configure & make works with OpenSSL_1_0_2-stable 
./Configure  --prefix=${prefix} --cross-compile-prefix=arm-linux-androideabi- no-shared android-armv7 || exit 1
ANDROID_DEV="${sysroot}/usr" make build_libcrypto build_libssl openssl.pc install_sw DIRS='crypto ssl engines' || exit 1

